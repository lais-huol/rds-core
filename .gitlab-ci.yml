stages:
  - test
  - publish
  - deploy


static-type-check:
  stage: test
  image: python:3.10
  script:
    - pip install mypy lxml
    - mypy --warn-unused-configs --python-version 3.10 --show-error-context --show-column-numbers --show-error-end --show-error-codes  --pretty --html-report statictypecheck --cobertura-xml-report statictypecheck  bds_framework
    # --disallow-untyped-calls --disallow-untyped-defs
  artifacts:
    paths:
      - statictypecheck
    expire_in: 30 days
  allow_failure: true


lint:
  stage: test
  image: python:3.10
  script:
    - pip install flake8
    - flake8
  artifacts:
    paths:
      - htmlcov
    expire_in: 30 days
  allow_failure: true


unit-test:
  stage: test
  image: python:3.10
  script:
    - pip install pytest pytest-cov pytest-profiling
    - python -m pytest --cov-report=html -W ignore:InsecureRequestWarning --cov=.
  artifacts:
    paths:
      - htmlcov
    expire_in: 30 days
  allow_failure: true


documentation:
  stage: publish
  image: python:3.10
  script:
    - sed -i 's@!!gitlabpages!!@'${CI_PAGES_URL}'@' public/index.html
    - pip install -r requirements.txt
    - pdoc --html -o docs --config show_source_code=False --force bds_framework/
#    - mkdir -p public/coverage
#    - mv coverage/* public/coverage/
    - mkdir -p public/docs
    - mv docs/* public/docs/
  artifacts:
    paths:
      - public
    expire_in: 30 days
  allow_failure: true


python-deploy:
  image: registry.lais.huol.ufrn.br/sistemas-internos/python_package_deploy:1-0-5
  stage: deploy
  script:
    - sed -i "s/version='.*',/version='$CI_COMMIT_TAG',/g" setup.py
    - python setup.py sdist bdist_wheel
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  only:
    - tags

# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/#customizing-settings
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence

sast:
  stage: test

include:
  - template: Security/SAST.gitlab-ci.yml
